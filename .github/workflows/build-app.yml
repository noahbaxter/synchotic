name: Build App

on:
  workflow_call:
    inputs:
      upload_artifacts:
        description: 'Whether to upload build artifacts'
        type: boolean
        default: true
      version_suffix:
        description: 'Suffix to append to VERSION (e.g. dev build timestamp)'
        type: string
        default: ''

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            name: macos
            artifact: app-macos.zip
          - os: windows-latest
            name: windows
            artifact: app-windows.zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Stamp version
        if: inputs.version_suffix != ''
        run: |
          TIMESTAMP=$(date -u +%Y%m%d.%H%M)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "$(cat VERSION)-${{ inputs.version_suffix }}.${TIMESTAMP}.${SHORT_SHA}" > VERSION
          cat VERSION
        shell: bash

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Inject API key for build
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          if [ "${{ matrix.name }}" = "windows" ]; then
            sed -i 's/os.environ.get("GOOGLE_API_KEY", "")/"'"$GOOGLE_API_KEY"'"/' sync.py
          else
            sed -i '' 's/os.environ.get("GOOGLE_API_KEY", "")/"'"$GOOGLE_API_KEY"'"/' sync.py
          fi
        shell: bash

      - name: Setup UnRAR library
        uses: ./.github/actions/setup-unrar

      - name: Build app (macOS)
        if: matrix.name == 'macos'
        run: |
          CERTIFI_PATH=$(python -c "import certifi; print(certifi.where())")
          pyinstaller --onedir --name synchotic-app --clean --noconfirm \
            --add-data "drives.json:." \
            --add-data "VERSION:." \
            --add-data "$CERTIFI_PATH:certifi" \
            --add-binary "libs/bin/unrar:." \
            --hidden-import certifi \
            --hidden-import rarfile \
            sync.py

      - name: Build app (Windows)
        if: matrix.name == 'windows'
        run: |
          $CERTIFI_PATH = python -c "import certifi; print(certifi.where())"
          pyinstaller --onedir --name synchotic-app --clean --noconfirm `
            --add-data "drives.json;." `
            --add-data "VERSION;." `
            --add-data "$CERTIFI_PATH;certifi" `
            --add-binary "libs/bin/UnRAR.exe;." `
            --hidden-import certifi `
            --hidden-import rarfile `
            sync.py
        shell: pwsh

      - name: Add version file
        run: cp VERSION dist/synchotic-app/.version
        shell: bash

      - name: Create app zip (macOS)
        if: matrix.name == 'macos'
        run: |
          cd dist/synchotic-app
          zip -r -q ../app-macos.zip .

      - name: Create app zip (Windows)
        if: matrix.name == 'windows'
        run: |
          cd dist
          Compress-Archive -Path "synchotic-app\*" -DestinationPath "app-windows.zip" -Force
        shell: pwsh

      - name: Upload artifact
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}
