name: Update Manifest

on:
  workflow_dispatch:
    inputs:
      force_rescan:
        description: 'Force complete rescan (ignore existing manifest)'
        required: false
        default: 'false'
        type: boolean
      branch:
        description: 'Branch to run from (for testing)'
        required: false
        default: 'main'
        type: string

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Set up OAuth credentials
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
          echo '${{ secrets.GOOGLE_TOKEN }}' > token.json

      - name: Download existing manifest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download existing manifest from release (has the changes_token)
          gh release download manifest --pattern "manifest.json" --clobber || echo "No existing manifest, will do full scan"

      - name: Run manifest generator
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          # Force rescan if requested
          if [ "${{ inputs.force_rescan }}" = "true" ]; then
            echo "Force rescan requested"
            python manifest_gen.py --force
          # Check if manifest exists AND has folder data (not just a token stub)
          elif [ -f manifest.json ] && python -c "import json; m=json.load(open('manifest.json')); exit(0 if m.get('folders') else 1)"; then
            # Incremental update using existing manifest's changes_token
            python manifest_gen.py
          else
            # First run or empty manifest: need full scan
            python manifest_gen.py --full
          fi

      - name: Upload manifest to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create release if it doesn't exist
          gh release view manifest || gh release create manifest --title "Manifest" --notes "Auto-updated manifest for chart sync"

          # Upload/replace the manifest asset
          gh release upload manifest manifest.json --clobber

      - name: Summary
        run: |
          echo "### Manifest Updated" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(du -h manifest.json | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- Files: $(python -c "import json; m=json.load(open('manifest.json')); print(sum(f.get('file_count',0) for f in m.get('folders',[])))")" >> $GITHUB_STEP_SUMMARY
